--Code to import csv, must be done in sqlite3 command line I believe
-- Trying to bash script this...
/*
.open .../marcello/sqlite-tools/splitwiseDB.db
.mode csv
.import /marcello/splitwiseAPI/splitwise_export_trxn import_trxn
.import /marcello/splitwiseAPI/splitwise_export_users import_users
.read updateMaster2
.read update_master_with_changed2--this file
*/

--Updates modified expenses
--Unfortunately, cannot use INNER JOIN and UPDATE so must use "replace into"
--Currently this adds the row, but does not delete the old row...?
REPLACE INTO testMaster2 (tableID, expenseID, description, cost, 
    txnDate,category,groupName, updatedAt, deletedAt)
SELECT testMaster2.tableID, import_trxn.*    
FROM import_trxn
INNER JOIN testMaster2 ON import_trxn.expenseID = testMaster2.expenseID --Do i need a join here?
WHERE testMaster2.expenseID IN (
    SELECT expenseID FROM import_trxn WHERE import_trxn.UpdatedAt > testMaster2.updatedAt
);
REPLACE INTO testUsers (tableID, UserName, UserBalance, expenseID)
SELECT testUsers.tableID, import_users.*
FROM import_users
INNER JOIN testUsers ON import_users.expenseID = testUSers.expenseID --Do i really need a join here?
    AND import_users.UserName =testUsers.UserName
WHERE testUsers.expenseID IN (
    SELECT import_trxn.expenseID
    FROM import_trxn INNER JOIN testMaster2 ON testMaster2.expenseID = import_trxn.expenseID
    WHERE import_trxn.UpdatedAt > testMaster2.updatedAt
);

--DON"T DROP TABLES YET: DROP TABLE import_trxn, import_users

/*This method does not account for expense changes that add or remove USers,
 since it only modifies the existing user balances*/
/* 2 notes: THis method runs into issues when PRAGMA foreign_keys=ON. Don't understand but there's the note.
I can chose to update only a few columns in the same way I didn't achange the PrimaryKey, 
pull data from the inserted into table itself, not the new data */
