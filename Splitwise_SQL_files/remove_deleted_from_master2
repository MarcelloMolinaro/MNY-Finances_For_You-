--Code to import csv, must be done in sqlite3 command line I believe
-- Trying to bash script this...
/*
.open .../marcello/sqlite-tools/splitwiseDB.db
.mode csv
.import /marcello/splitwiseAPI/splitwise_export_trxn import_trxn
.import /marcello/splitwiseAPI/splitwise_export_users import_users
.read updateMaster2
.read update_master_with_changed2
.read remove_deleted_from_master2--this file
*/

--Removes deleted expenses from master table
WITH del_data AS (
    SELECT * FROM import_trxn
    WHERE deletedAt IS NOT "")
DELETE FROM testMaster2
WHERE testMaster2.expenseID IN (
    SELECT del_data.expenseID FROM del_data
);
--Might be better to create a temp table here? rather than CTE twice?
WITH del_data AS (
    SELECT * FROM import_trxn
    WHERE deletedAt IS NOT "")
DELETE FROM testUsers
WHERE testUsers.expenseID IN (
    SELECT del_data.expenseID FROM del_data
);
--Adds THESE EXPENSES TO THE testDELETED TABLES
INSERT INTO testDeleted_trxn (expenseID, description, cost, 
    txnDate,category,groupName, updatedAt, deletedAt)
SELECT * FROM import_trxn
WHERE deletedAt IS NOT "" 
    AND import_trxn.expenseID NOT IN (SELECT expenseID FROM testDeleted_trxn);

INSERT INTO testDeleted_users (UserName, UserBalance, expenseID)
SELECT * FROM import_users
WHERE import_users.expenseID IN (SELECT expenseID FROM import_trxn WHERE deletedAt IS NOT "")
    AND import_users.expenseID NOT IN (SELECT expenseID FROM testDeleted_users);

DROP TABLE import_trxn;
DROP TABLE import_users;
--BACKUP/COMMIT;

/* What about when something gets Un-Deleted? 
How to handle that case???
I would need to remove it from this table and also add 
it to the main table, not modfy an existing expense...
*/